<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <!-- 메타 정보 선언 -->
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>

    <!-- 제이쿼리 모바일, 제이쿼리 라이브러리 파일 선언 -->
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />

    <!-- 사용자 스타일 시트 파일 선언 -->
    <link rel='stylesheet' href='/stylesheets/parts-main-style.css' />
</head>
<body>
    <!-- 기본 분석자용 메인 페이지 -->
    <div data-role='header' data-position="fixed">
        <h4><%= result.partName %></h4>
    </div>
    <div data-role="content">
        <img id="home" src="http://localhost:3000/imgs/home.png"/><p class="hello"><b><%= result.name %></b> <B><%= result.departmentPosition %></B>님 반갑습니다.</p>
        <fieldset class="parts-main-radio-btns" data-role="controlgroup" data-type="horizontal" data-mini="true">
            <input type="radio" name="radio-choice-1" id="analyst-report" value="7" checked="checked"/>
            <label class="partsmain-radio-labels" id="analyst-report-label" for="analyst-report">내근자 업무 보고</label>
            <input type="radio" name="radio-choice-1" id="owns-team" value="1"/>
            <label class="partsmain-radio-labels" id="owns-team-label" for="owns-team">외근팀 관리</label>
            <input type="radio" name="radio-choice-1" id="file-upload" value="2"/>
            <label class="partsmain-radio-labels" for="file-upload">계획서 업로드</label>
            <input type="radio" name="radio-choice-1" id="error-state" value="3"/>
            <label class="partsmain-radio-labels" for="error-state">오류 현황</label>
            <input type="radio" name="radio-choice-1" id="call-state" value="5"/>
            <label class="partsmain-radio-labels" for="call-state">콜수 현황</label>
            <input type="radio" name="radio-choice-1" id="car-state" value="4"/>
            <label class="partsmain-radio-labels" for="car-state">차량 현황</label>
            <% if (result.teamPosition === 0) { %>
            <input type="radio" name="radio-choice-1" id="admin-page" value="6"/>
            <label class="partsmain-radio-labels" for="admin-page">관리자 페이지</label>
            <% } %>
        </fieldset>

        <!-- 내근자 업무보고 탭, 팀 관리 탭, 계획서 업로드 탭 -->
        <ul id="listArea" data-role="listview" data-inset="true">
        </ul>

        <!-- 오류 현황 탭 -->
        <div id="error-state-div">
            <input class="error-state" type="button" id="dayErrorBtn" value="일별 에러 현황"/>
            <input class="error-state" type="button" id="weekErrorBtn" value="주별 에러 현항"/>
            <input class="error-state" type="button" id="monthErrorBtn" value="월별 에러 현황"/>
            <input class="error-state" type="button" id="quarterErrorBtn" value="분기별 에러 현황"/>
        </div>

        <!-- 콜수 현황 탭 -->
        <div id="calls-state-div">
            <input class="call-state" type="button" id="dayCallsBtn" value="일별 콜수 현황"/>
            <input class="call-state" type="button" id="monthCallsBtn" value="월별 콜수 현황"/>
        </div>

        <a class="ui-btn ui-btn-inline ui-mini" id="logoutBtn">로그아웃</a>
    </div>
    <div data-role="footer" data-position="fixed">
        <h4>icomwiz</h4>
    </div>
    <script>
        //내근자 업무보고 탭을 눌렀을 때 실행되는 function
        function analystReport() {
            $('#calls-state-div').hide();
            $('#error-state-div').hide();
            $.get('http://localhost:3000/analystReports/me', function(data) {
                $('#listArea').empty();
                $.each(data.result, function() {
                    $('#listArea').append("<li data-role=\"collapsible\" data-iconpos=\"right\" data-shadow=\"false\" data-corners=\"false\">" +
                                            "<h2>" + this.date + " 업무 보고" + "</h2>" +
                                            "<div>" +
                                                "<table>" +
                                                    "<thead>" +
                                                        "<tr>" +
                                                            "<td colspan='2'>" + '근태 현황' + "</td>" + "<td>" + "주 업무" + "</td>" +
                                                        "</tr>" +
                                                    "</thead>" +
                                                    "<tbody>" +
                                                        "<tr>" +
                                                            "<td>" + '출근' + "</td>" + "<td>" + (this.workStartTime || '') + "</td>" + "<td rowspan='2'>" + this.majorJob + "</td>" +
                                                        "<tr>" +
                                                            "<td>" + '퇴근' + "</td>" + "<td>" + (this.workEndTime || '') + "</td>" +
                                                        "</tr>" +
                                                            "<td>" + '기타' + "</td>" + "<td>" + (this.etc ||'') + "</td>" + "<td>" + "</td>" +
                                                        "<tr>" +
                                                            "<td>" + '야근' + "</td>" + "<td>" + (this.overTime || '') + "</td>" + "<td>" + "</td>" +
                                                        "</tr>" +
                                                            "<td>" + '휴가' + "</td>" + "<td>" + (this.vacation || '') + "</td>" + "<td>" + "</td>" +
                                                        "<tr>" +
                                                    "</tbody>" +
                                                "</table>" +
                                            "</div>" +
                                            "<ul id=" + "\"" + this.date +"\"" + " data-role=\"listview\" data-theme=\"d\" data-inset=\"true\"></ul>" +
                                          "</li>");
                    $('#listArea li').collapsible();
                    var dateSelector = '#' + this.date;
                    $.ajax({
                        url: "http://localhost:3000/analystReportDetails",
                        type: "GET",
                        dataType: "JSON",
                        data: { date: this.date },
                        success: function(data) {
                            for (var i = 0; i < data.result.length; i++) {
                                $(dateSelector).append('<li>' + 'hi' + '</li>');
                            }
                            $('#listArea').trigger('create');
                            $(dateSelector).listview('refresh');
                        },
                        error: function(data) {
                            alert("접속 에러");
                        }
                    });
                });
            });
        }

        //팀을 선택시 해당 팀의 날짜별 report들을 불러오는 function
        function getReport(teamId) {
            $.ajax({
                url: "http://localhost:3000/reports",
                type: "GET",
                dataType: "JSON",
                data: {
                    action: 1,
                    teamId: teamId
                },
                success: function(data) {
                    $('#listArea').empty();
                    for(var i = 0; i < data.result.length; i++) {
                        $('#listArea').append("<li data-inset=\"true\" class=\"allteamlist\">" +
                                                    "<span class=\"allteamlistdate\">" + data.result[i].date + "</span>" + "<br/>" +
                                                    "측정장소 : " + "<span class=\"allteamlistlocation\">" + data.result[i].location + "</span>" + "<br/>" +
                                                    "측정팀 : " + "<span class=\"allteamlistteam\">" + data.result[i].teamName + " " + data.result[i].teamNo + "조" + "</span>" +
                                                    "<input type=\"hidden\" class=\"allteamlistteamid\" value=\""+ teamId +"\"/>" +
                                              "</li>");
                    }
                    $('#listArea').trigger('create');
                    $('#listArea').listview('refresh');
                },
                error: function(data) {
                    alert('접속 에러');
                }
            });
        }

        //팀관리 탭을 선택했을 때 실행되는 function
        function teamManagement() {
            $('#calls-state-div').hide();
            $('#error-state-div').hide();
            $.get("http://localhost:3000/teams/simple", function(data) {
                $('#listArea').empty();
                $.each(data.result, function() {
                    $('#listArea').append("<li data-role=\"collapsible\" data-iconpos=\"right\" data-shadow=\"false\" data-corners=\"false\">" +
                            "<h2>"+this.teamName+"</h2>" +
                            "<ul id=" + "\"" + this.teamName +"\"" + "data-role=\"listview\" data-theme=\"d\" data-inset=\"true\"></ul>" +
                            "</li>");
                    $("#listArea li").collapsible();
                    var teamNameSelector = '#' + this.teamName;
                    $.ajax({
                        url: "http://localhost:3000/teams",
                        type: "GET",
                        dataType: "JSON",
                        data: { teamName: this.teamName },
                        success: function(data) {
                            if( data.result ) {
                                for(var i = 0; i < data.result.length; i++) {
                                    $(teamNameSelector).append("<li class=\"teamList\" data-role=\"listview\" id=" + "\"" + data.result[i].teamId +"\"" + ">" +
                                                                    data.result[i].teamName + " " +data.result[i].teamNo + "조" +
                                                               "</li>");
                                    var teamIdSelector = '#' + data.result[i].teamId;
                                    $(teamIdSelector).click(function() {
                                        getReport(this.id);
                                    });
                                }
                                $('#listArea').trigger('create');
                                $(teamNameSelector).listview('refresh');
                            }
                        },
                        error: function(data) {
                            alert("접속 에러");
                        }
                    });
                });
            });
        }

        //파일업로드 탭을 선택했을 때 실행되는 function
        function fileUpload() {
            $('#calls-state-div').hide();
            $('#error-state-div').hide();
            $('#listArea').empty();
            $('#listArea').append("<li>" +
                                    "<input id=\"file\" type=\"file\" name=\"uploadExcelfile\" />" +
                                    "<input type=\"button\" id=\"uploadbtn\" value=\"계획서 업로드\" />" +
                                  "</li>" +
                                  "<li>" +
                                    "<input type=\"button\" id=\"formDownloadbtn\" value=\"엑셀양식 다운로드\" />" +
                                  "</li>");
            $('#listArea').trigger('create');
            $('#listArea').listview('refresh');
        }

        //오류현황 탭을 선택했을 때 폼을 실행되는 function
        function errorState() {
            $('#listArea').empty();
            $('#calls-state-div').css('display','none');
            $('#error-state-div').show();
            $('#listArea').listview('refresh');
        }

        //콜수 현황 탭을 선택했을 때 실행되는 function
        function callState() {
            $('#listArea').empty();
            $('#error-state-div').css('display','none');
            $('#calls-state-div').show();
            $('#listArea').listview('refresh');
        }

        //관리자 페이지 탭을 선택했을 때 실행되는 fucntion
        function adminPage() {
            $('#calls-state-div').hide();
            $('#error-state-div').hide();

            //오늘날짜계산함수
            function date(){
                var date = new Date();

                var year  = date.getFullYear();
                var month = date.getMonth() + 1; // 0부터 시작하므로 1더함 더함
                var day   = date.getDate();

                if(month < 10) {
                    month = "0"+month;
                }
                if(day < 10) {
                    day = "0"+day
                }
                return year +'-'+month+'-'+day;
            }

            return window.location.href = "http://localhost:3000/employees/admin?date="+date();
        }

        //html파싱이 완료 된 후 실행되는 function
        $(function() {
            var radioChecked = $('input:radio[name=radio-choice-1]:checked').val();
            switch (radioChecked) {
                case '1':
                    teamManagement();
                    break;
                case '2':
                    fileUpload();
                    break;
                case '3':
                    errorState();
                    break;
                case '4':
                    //
                    break;
                case '5':
                    callState();
                    break;
                case '6':
                    //
                    break;
                case '7':
                    analystReport();
                    break;
            }

            $('#home').click(function() {
                $("#owns-team-label").trigger('click');
            });

            //내근자 업무보고 탭이 클릭 되었을 시
            $("#analyst-report").click(function() {
                analystReport();
            });

            //팀관리 탭이 클릭되었을 시
            $("#owns-team").click(function() {
                teamManagement();
            });

            //파일 업로드 탭이 클릭 되었을 시
            $("#file-upload").click(function() {
                fileUpload();
            });

            //오류현황 탭이 클릭 되었을 시
            $("#error-state").click(function() {
                errorState();
            });

            $("#call-state").click(function() {
                callState();
            })

            //차량현황 탭이 클릭 되었을 시
            $("#car-state").click(function() {
                $('#calls-state-div').hide();
                $('#error-state-div').hide();
                return window.location.href = "http://localhost:3000/reports/cars";
            });

            //관리자 페이지 탭이 클릭 되었을 시
            $('#admin-page').click(function() {
                adminPage();
            });

            //파일 업로드 버튼이 클릭 되었을 시
            $(document).on('click', '#uploadbtn', function() {
                var formData = new FormData();
                formData.append("uploadExcelfile", $("input[name=uploadExcelfile]")[0].files[0]);
                if( $("#file").val() != "" ){
                    var ext = $('#file').val().split('.').pop().toLowerCase();
                    if($.inArray(ext, ['xlsm','xlsx']) == -1) {
                        alert('xlsx 파일만 업로드 할수 있습니다.');
                        return;
                    }
                    $.ajax({
                        url:'http://localhost:3000/reports/planner',
                        processData: false,
                        contentType: false,
                        data: formData,
                        type: 'POST',
                        success: function(data) {
                            alert(data.result);
                        }
                    });
                } else {
                    alert('파일을 선택해 주세요');
                }
            });

            //엑셀 양식 다운로드 버튼이 클릭되었을 시
            $(document).on('click', '#formDownloadbtn', function() {
                return window.location.href = "http://localhost:3000/excelforms";
            });

            // 팀(ex QOE팀 1조)을 눌렀을 때 실행
            $(document).on('click', '.allteamlist', function() {
                var queryStr = '?action=2&teamId=' + $(this).children(".allteamlistteamid").val() + '&date=' + $(this).children(".allteamlistdate").text();
                return window.location.href = "http://localhost:3000/reports" + queryStr;
            });

            // 오류현황 탭의 목록이 선택되었을 시
            $('#dayErrorBtn').click(function() {
                return window.location.href = "http://localhost:3000/reports/statistics?action=0";
            });
            $('#weekErrorBtn').click(function() {
                return window.location.href = "http://localhost:3000/reports/statistics?action=1";
            });
            $('#monthErrorBtn').click(function() {
                return window.location.href = "http://localhost:3000/reports/statistics?action=2";
            });
            $('#quarterErrorBtn').click(function() {
                return window.location.href = "http://localhost:3000/reports/statistics?action=3";
            });

            //콜수 현황탭의 목록이 선택되었을 시
            $('#dayCallsBtn').click(function() {
                return window.location.href = "http://localhost:3000/reports/calls?action=0";
            });
            $('#monthCallsBtn').click(function() {
                return window.location.href = "http://localhost:3000/reports/calls?action=1";
            });

            //로그아웃
            $('#logoutBtn').click(function() {
                alert('로그아웃 합니다.');
                return window.location.href = "http://localhost:3000/auth/logout"
            });
        });
    </script>
</body>
</html>